{% extends "layout/layout.html" %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
    <h6 class="fw-semibold mb-0">Crear Usuario</h6>
    <ul class="d-flex align-items-center gap-2">
        <li class="fw-medium">
            <a href="{% url 'usersList' %}" class="d-flex align-items-center gap-1 hover-text-primary">
                <iconify-icon icon="solar:users-group-rounded-outline" class="icon text-lg"></iconify-icon>
                Usuarios
            </a>
        </li>
        <li>-</li>
        <li class="fw-medium">Agregar Usuario</li>
    </ul>
</div>

<div class="card h-100 p-0 radius-12">
    <div class="card-body p-24">
        <div class="row justify-content-center">
            <div class="col-xxl-6 col-xl-8 col-lg-10">
                <div class="card border">
                    <div class="card-body">
                        <h6 class="text-md text-primary-light mb-16">Crear Nuevo Usuario</h6>
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="post" id="formAddUser">
                            {% csrf_token %}
                            <div class="row gy-3">
                                <div class="col-sm-6">
                                    <label class="form-label">Organización <span class="text-danger">*</span></label>
                                    {{ perfil_form.organizacion }}
                                    {% if perfil_form.organizacion.errors %}<div class="text-danger mt-1">{{ perfil_form.organizacion.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Rol del Sistema <span class="text-danger">*</span></label>
                                    {{ perfil_form.rol }}
                                    {% if perfil_form.rol.errors %}<div class="text-danger mt-1">{{ perfil_form.rol.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                    {{ user_form.first_name }}
                                    {% if user_form.first_name.errors %}<div class="text-danger mt-1">{{ user_form.first_name.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Apellido <span class="text-danger">*</span></label>
                                    {{ user_form.last_name }}
                                    {% if user_form.last_name.errors %}<div class="text-danger mt-1">{{ user_form.last_name.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Nombre de Usuario <span class="text-danger">*</span></label>
                                    {{ user_form.username }}
                                    {% if user_form.username.errors %}<div class="text-danger mt-1">{{ user_form.username.errors.0 }}</div>{% endif %}
                                    <small class="text-secondary-light">Se generará automáticamente al elegir organización y nombre</small>
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Correo Electrónico <span class="text-danger">*</span></label>
                                    {{ user_form.email }}
                                    {% if user_form.email.errors %}<div class="text-danger mt-1">{{ user_form.email.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Contraseña</label>
                                    {{ user_form.password }}
                                    {% if user_form.password.errors %}<div class="text-danger mt-1">{{ user_form.password.errors.0 }}</div>{% endif %}
                                    <small class="text-secondary-light">Se autocompletará como usuario + <code>123*</code>. El usuario deberá cambiarla al ingresar.</small>
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label">Confirmar Contraseña</label>
                                    {{ user_form.confirm_password }}
                                    {% if user_form.confirm_password.errors %}<div class="text-danger mt-1">{{ user_form.confirm_password.errors.0 }}</div>{% endif %}
                                </div>

                                <div class="col-12 d-flex align-items-center gap-3">
                                    <button type="submit" class="btn btn-primary border border-primary-600 text-md px-56 py-12 radius-8">Crear Usuario</button>
                                    <a href="{% url 'usersList' %}" class="btn btn-outline-primary border border-primary-600 text-md px-56 py-12 radius-8">Cancelar</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper para obtener texto del option seleccionado (Django usa __str__ del objeto)
    function getOrgCodeFromOption(select) {
        const opt = select.options[select.selectedIndex];
        if (!opt) return '';
        // se espera formato 'Nombre (CODE)' o 'Nombre (CODE)'
        const txt = opt.text || '';
        const m = txt.match(/\(([^)]+)\)\s*$/);
        if (m && m[1]) return m[1];
        // fallback: tomar primera palabra
        return txt.split(' ')[0] || '';
    }

    const orgSelect = document.querySelector('#id_organizacion');
    const firstName = document.querySelector('#id_first_name');
    const lastName = document.querySelector('#id_last_name');
    const usernameInput = document.querySelector('#id_username');
    const pwdInput = document.querySelector('#id_password');
    const confirmPwd = document.querySelector('#id_confirm_password');

    function generateCredentials() {
        try {
            const orgCode = orgSelect ? getOrgCodeFromOption(orgSelect).trim() : '';
            const fn = firstName ? firstName.value.trim() : '';
            const ln = lastName ? lastName.value.trim() : '';
            if (!orgCode || !fn || !ln) return;
            const uname = `${orgCode}_${fn.charAt(0).toUpperCase()}${ln.replace(/\s+/g,'')}`;
            if (usernameInput) usernameInput.value = uname;
            const pwd = `${uname}123*`;
            if (pwdInput) pwdInput.value = pwd;
            if (confirmPwd) confirmPwd.value = pwd;
        } catch(e) {
            // no romper
            console.error(e);
        }
    }

    if (orgSelect) orgSelect.addEventListener('change', generateCredentials);
    if (firstName) firstName.addEventListener('input', generateCredentials);
    if (lastName) lastName.addEventListener('input', generateCredentials);
});
</script>
{% endblock %}